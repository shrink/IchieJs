/*! IchieJs - v0.1.0 - 2012-07-11
* https://github.com/shrink/IchieJs/
* Copyright (c) 2012 Thorsten Schmitt-Rink; Licensed MIT */
(function(a,b,c){var d=a.Kinetic,e=function(){this.options=null,this.stage=null,this.layer=null,this.image=null,this.image_selection=null};e.prototype={init:function(a,c){this.options=b.extend({},e.DEFAULT_OPTIONS,c||{}),this.image_selection=new f,this.layer=new d.Layer({id:"image-layer"}),this.stage=new d.Stage({container:a,width:this.options.width,height:this.options.height}),this.stage.add(this.layer)},launch:function(a,b){var c=this,d=new Image;d.onload=function(){c.image=c.createKineticImage(d),c.layer.add(c.image),c.layer.draw(),c.image_selection.init(c,{width:c.options.width/2,height:c.options.height/2}),b()},d.src=a},createKineticImage:function(a){var b=a.naturalWidth,c=a.naturalHeight;return new d.Image({image:a,x:this.stage.getWidth()/2-b/2,y:this.stage.getHeight()/2-c/2,width:b,height:c,id:"src-image"})},showSelection:function(){this.image_selection.show()},hideSelection:function(){this.image_selection.hide()},getStage:function(){return this.stage},getLayer:function(){return this.layer},getImage:function(){return this.image}},e.DEFAULT_OPTIONS={width:500,height:300};var f=function(){this.ichie=null,this.stage=null,this.options=null,this.ratio=null,this.shapes_groupGroup=null,this.layer=null,this.resize_handles=null,this.selection_rect=null,this.resizeInteraction=null};f.prototype={init:function(a,c){this.ichie=a,this.stage=a.getStage(),this.options=b.extend({},f.DEFAULT_OPTIONS,c||{}),this.selection_rect=this.createSelectionRect(),this.ratio=this.selection_rect.getWidth()/this.selection_rect.getHeight(),this.resize_handles=this.createResizeHandles(),this.shapes_group=this.createShapesGroup(),this.layer=new d.Layer({id:"selection-layer",alpha:this.options.show?1:0}),this.layer.add(this.shapes_group),this.stage.add(this.layer),this.resizeInteraction=new g,this.resizeInteraction.init(this)},createSelectionRect:function(){return new d.Rect({id:"selection-rect",width:this.options.width,height:this.options.height,fill:"rgba(0, 0, 0, 0)",stroke:"white",strokeWidth:this.options.stroke,x:0,y:0})},createResizeHandles:function(){var a=this,b=[],d=this.calculateResizeHandleCoordMap();return c.each(f.HANDLES,function(c){b.push(a.createResizeHandle(c,d))}),b},createResizeHandle:function(a,b){return new d.Rect({width:this.options.size,height:this.options.size,fill:this.options.fill,stroke:this.options.stroke,strokeWidth:this.options.stroke_width-1,x:b[a.x],y:b[a.y]})},calculateResizeHandleCoordMap:function(){return{north:-1*(this.options.size/2),east:this.selection_rect.getWidth()-this.options.size/2,south:this.selection_rect.getHeight()-this.options.size/2,west:-1*(this.options.size/2),center:this.selection_rect.getWidth()/2-this.options.size/2,middle:this.selection_rect.getHeight()/2-this.options.size/2}},createShapesGroup:function(){var a=new d.Group({draggable:!0,x:this.stage.getWidth()/2-this.options.width/2,y:this.stage.getHeight()/2-this.options.height/2});return a.setDragBounds(this.calculateDragBounds()),a.add(this.selection_rect),c.each(this.resize_handles,function(b){a.add(b)}),a},calculateDragBounds:function(){var a=this.ichie.getImage(),b=a.getAbsolutePosition();return{top:b.y,left:b.x,right:b.x+a.getWidth()-this.selection_rect.getWidth(),bottom:b.y+a.getHeight()-this.selection_rect.getHeight()}},correctResizeHandlePositions:function(){var a=this,b=0,d=this.calculateResizeHandleCoordMap();c.each(f.HANDLES,function(c){var e=a.resize_handles[b++];e.setX(d[c.x]),e.setY(d[c.y])})},getSelection:function(){var a=this.selection_rect.getAbsolutePosition(),b=this.ichie.getImage().getAbsolutePosition(),c=a.x-b.x,d=a.y-b.y;return{top:d,right:c+this.selection_rect.getWidth(),bottom:d+this.selection_rect.getHeight(),left:c}},setSelection:function(a){this.selection_rect.setWidth(a.dim.width),this.selection_rect.setHeight(a.dim.height),this.shapes_group.setX(a.pos.x),this.shapes_group.setY(a.pos.y),this.shapes_group.setDragBounds(this.calculateDragBounds()),this.correctResizeHandlePositions(),this.layer.draw()},getHandles:function(a){return b.merge([],this.resize_handles)},getSelectionRect:function(){return this.selection_rect},getLayer:function(){return this.layer},show:function(){this.layer.setAlpha(1),this.layer.draw()},hide:function(){this.layer.setAlpha(0),this.layer.draw()}},f.HANDLES=[{x:"west",y:"north"},{x:"center",y:"north"},{x:"east",y:"north"},{x:"east",y:"middle"},{x:"east",y:"south"},{x:"center",y:"south"},{x:"west",y:"south"},{x:"west",y:"middle"}],f.DEFAULT_OPTIONS={size:7,fill:"rgba(23, 23, 223, 1)",show:!1,stroke:"white",stroke_width:2,keep_ratio:!1};var g=function(){this.image_selection=null,this.handles=null,this.last_mousepos=null,this.mode=null,this.boundry=null};g.prototype={init:function(a){this.image_selection=a,this.handles=this.image_selection.getHandles(),this.canvas=b(this.image_selection.getLayer().getCanvas()),this.boundry=this.calculateBoundry(),this.mode=new i,this.mode.init(this),this.last_mousepos=null,this.registerHandleEvents()},calculateBoundry:function(){var a=this.image_selection.ichie,b=a.getImage(),c=b.getAbsolutePosition();return{top:c.y,right:c.x+b.getWidth(),bottom:c.y+b.getHeight(),left:c.x}},registerHandleEvents:function(){var a=function(a){var c=b.handles[a],d=function(c){b.onMouseMove(c,a)},e=function(a){b.image_selection.shapes_group.setDraggable(!0),b.last_mousepos=null,window.document.removeEventListener("mousemove",d),window.document.removeEventListener("mouseup",e)};c.on("mousedown touchstart",function(a){b.image_selection.shapes_group.setDraggable(!1),b.last_mousepos={x:a.pageX,y:a.pageY},window.document.addEventListener("mousemove",d),window.document.addEventListener("mouseup",e)})};for(var b=this,c=0;c<this.handles.length;c++)a(c)},onMouseMove:function(a,b){var c={x:a.pageX,y:a.pageY},d=this.image_selection.getSelectionRect(),e=d.getAbsolutePosition(),f=d.getWidth(),g=d.getHeight(),h=this.calculateEventDelta(b,c);this.image_selection.setSelection(this.mode.buildSelectGeometry(b,h)),this.last_mousepos=c},calculateEventDelta:function(a,b){var c=b.x,d=b.y,e=c-this.last_mousepos.x,f=d-this.last_mousepos.y,g=[0,6,7],h=[0,1,2];return-1!==g.indexOf(a)&&(e*=-1),-1!==h.indexOf(a)&&(f*=-1),{x:e,y:f}},getBoundry:function(){return this.boundry},getImageSelection:function(){return this.image_selection}},g.DIRECTION={HORIZONTAL:"horizontal",VERTICAL:"vertical",BOTH:"both"},g.MODE={DEFAULT:"default",RATIO:"ratio"};var h=function(){this.interaction=null};h.prototype={init:function(a){this.interaction=a},buildSelectGeometry:function(a,b){return this.clipSelectionToBoundry({pos:this.calculateSelectPostion(a,b),dim:this.calculateSelectDimensions(a,b)})},calculateSelectDimensions:function(a,b){var c=this.interaction.getImageSelection(),d=c.getSelectionRect(),e=d.getWidth(),f=d.getHeight(),h=g.DIRECTION,i=this.determineResizeDirection(a,b);return e+=i===h.HORIZONTAL||i===h.BOTH?b.x:0,f+=i===h.VERTICAL||i===h.BOTH?b.y:0,{width:e,height:f}},determineResizeDirection:function(a,b){var d=g.DIRECTION,e=null,f={};return f[d.HORIZONTAL]=[3,7],f[d.VERTICAL]=[1,5],f[d.BOTH]=[0,2,4,6],c.each(f,function(b,c){-1!==b.indexOf(a)&&(e=c)}),e},calculateSelectPostion:function(a,b){var c=this.interaction.getImageSelection(),d=c.getSelectionRect(),e=d.getAbsolutePosition(),f=e.x,g=e.y,h=[0,6,7],i=[0,1,2];return f-=-1!==h.indexOf(a)?b.x:0,g-=-1!==i.indexOf(a)?b.y:0,{x:f,y:g}},clipSelectionToBoundry:function(a){var b=this.interaction.getImageSelection(),c=this.interaction.getBoundry(),d=a.pos,e=a.dim,f=b.getSelectionRect(),g=f.getAbsolutePosition(),h={top:d.y,right:d.x+e.width,bottom:d.y+e.height,left:d.x},i={width:f.getWidth(),height:f.getHeight()};return h.left<c.left&&(d.x=c.left,e.width=i.width+(g.x-d.x)),h.right>c.right&&(e.width=c.right-d.x),h.top<c.top&&(d.y=c.top,e.height=i.height+(g.y-d.y)),h.bottom>c.bottom&&(e.height=c.bottom-d.y),{pos:d,dim:e}}};var i=function(){h.prototype.constructor.call(this)};i.prototype=new h,i.prototype.constructor=i,i.prototype.buildSelectGeometry=function(a,b){var c=h.prototype.buildSelectGeometry.call(this,a,b),d=this.interaction.getImageSelection(),e=g.DIRECTION,f=this.determineResizeDirection(a,b),i=c.dim,j=c.pos,k=this.interaction.getBoundry(),l=d.getSelectionRect(),m=l.getAbsolutePosition(),n=[0,6],o=[0,2];if(f===e.HORIZONTAL)if(j.y+i.height>=k.bottom&&3<=a&&7>=a&&l.getWidth()<=i.width)i.height=k.bottom-j.y,i.width=i.height*d.ratio,j.x=m.x;else if(j.y<=k.top&&0<=a&&2>=a&&l.getWidth()<=i.width){var p=j.y+i.height;j.y=k.top,i.height=k.top-j.y,i.width=i.height*d.ratio,j.x=m.x}else{var q=i.width/d.ratio;-1!==o.indexOf(a)&&(j.y=m.y-(q-l.getHeight())),i.height=q}else if(j.x+i.width>=k.right&&1<=a&&5>=a&&l.getHeight()<=i.height)i.width=k.right-j.x,i.height=i.width/d.ratio,j.y=m.y;else if(j.x<=k.left&&-1!==[0,6,7].indexOf(a)&&l.getHeight()<=i.height){var r=j.x+i.width;j.x=k.left,i.width=r-j.x,i.height=i.width/d.ratio,j.y=m.y}else{var s=i.height*d.ratio;-1!==n.indexOf(a)&&(j.x=m.x-(s-l.getWidth())),i.width=s}return{pos:j,dim:i}},i.prototype.determineResizeDirection=function(a,b){var c=g.DIRECTION,d=h.prototype.determineResizeDirection.call(this,a,b);return c.BOTH===d&&(d=Math.abs(b.x)<Math.abs(b.y)?c.VERTICAL:c.HORIZONTAL),d},a.IchieJs={create:function(a){var b=new e;return b.init(a),b}}})(typeof exports=="object"&&exports||this,$,_);